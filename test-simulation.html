<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест архівних операцій</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">Тест архівних операцій</h1>
        
        <div class="grid gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Стан системи</h2>
                <button id="checkStatus" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Перевірити стан
                </button>
                <div id="statusResult" class="mt-4"></div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Симуляція редагування</h2>
                <button id="simulateEdit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Симулювати редагування архівної картки
                </button>
                <div id="editResult" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script src="supabaseConfig.js"></script>
    <script src="dataService.js"></script>
    
    <script>
        const dataServiceInstance = new DataService();
        
        document.getElementById('checkStatus').addEventListener('click', async () => {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<p class="text-blue-600">Перевіряємо стан системи...</p>';
            
            try {
                await dataServiceInstance.initialize();
                
                const cards = await dataServiceInstance.getCards();
                const archivedCards = await dataServiceInstance.getArchivedCards();
                
                let archiveAnalysis = '';
                if (archivedCards.length > 0) {
                    archiveAnalysis = '<h3 class="font-semibold mt-4">Аналіз архівних карток:</h3><ul class="space-y-2">';
                    archivedCards.forEach((card, index) => {
                        const shouldStayInArchive = 
                            card.accountStatus === 'Активний' &&
                            card.cardStatus === 'Видано' &&
                            card.documents?.contract === true &&
                            card.documents?.survey === true &&
                            card.documents?.passport === true;
                        
                        archiveAnalysis += `
                            <li class="border-l-4 ${shouldStayInArchive ? 'border-green-500' : 'border-yellow-500'} pl-4">
                                <strong>${card.fullName}</strong><br>
                                Статус: ${card.accountStatus} | Картка: ${card.cardStatus}<br>
                                Документи: Договір:${card.documents?.contract ? '✅' : '❌'} 
                                Опитувальник:${card.documents?.survey ? '✅' : '❌'} 
                                Паспорт:${card.documents?.passport ? '✅' : '❌'}<br>
                                <span class="${shouldStayInArchive ? 'text-green-600' : 'text-yellow-600'}">
                                    ${shouldStayInArchive ? 'Залишається в архіві' : 'Потребує переміщення'}
                                </span>
                            </li>
                        `;
                    });
                    archiveAnalysis += '</ul>';
                }
                
                resultDiv.innerHTML = `
                    <div class="text-green-600">
                        <p>✅ Система працює!</p>
                        <p><strong>Активних карток:</strong> ${cards.length}</p>
                        <p><strong>Архівних карток:</strong> ${archivedCards.length}</p>
                        ${archiveAnalysis}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">❌ Помилка: ${error.message}</p>`;
                console.error('Помилка перевірки стану:', error);
            }
        });
        
        document.getElementById('simulateEdit').addEventListener('click', async () => {
            const resultDiv = document.getElementById('editResult');
            resultDiv.innerHTML = '<p class="text-blue-600">Симулюємо редагування...</p>';
            
            try {
                await dataServiceInstance.initialize();
                const archivedCards = await dataServiceInstance.getArchivedCards();
                
                if (archivedCards.length === 0) {
                    resultDiv.innerHTML = '<p class="text-yellow-600">⚠️ Немає карток в архіві для тестування</p>';
                    return;
                }
                
                const testCard = archivedCards[0];
                console.log('Оригінальна картка:', testCard);
                
                // Симулюємо зміну документів (зробимо так, щоб картка не відповідала умовам архіву)
                const modifiedCard = {
                    ...testCard,
                    documents: {
                        contract: false, // Змінюємо договір на false
                        survey: testCard.documents?.survey || false,
                        passport: testCard.documents?.passport || false
                    },
                    updatedAt: new Date().toISOString()
                };
                
                // Перевіряємо нову логіку
                const shouldStayInArchive = 
                    modifiedCard.accountStatus === 'Активний' &&
                    modifiedCard.cardStatus === 'Видано' &&
                    modifiedCard.documents?.contract === true &&
                    modifiedCard.documents?.survey === true &&
                    modifiedCard.documents?.passport === true;
                
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold">Тестова картка: ${testCard.fullName}</h3>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border rounded p-3">
                                <h4 class="font-medium">Оригінальні дані:</h4>
                                <p>Договір: ${testCard.documents?.contract ? '✅' : '❌'}</p>
                                <p>Опитувальник: ${testCard.documents?.survey ? '✅' : '❌'}</p>
                                <p>Паспорт: ${testCard.documents?.passport ? '✅' : '❌'}</p>
                            </div>
                            
                            <div class="border rounded p-3">
                                <h4 class="font-medium">Змінені дані:</h4>
                                <p>Договір: ${modifiedCard.documents?.contract ? '✅' : '❌'}</p>
                                <p>Опитувальник: ${modifiedCard.documents?.survey ? '✅' : '❌'}</p>
                                <p>Паспорт: ${modifiedCard.documents?.passport ? '✅' : '❌'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-${shouldStayInArchive ? 'green' : 'yellow'}-100 border border-${shouldStayInArchive ? 'green' : 'yellow'}-300 rounded p-3">
                            <p class="font-medium">Результат перевірки:</p>
                            <p class="text-${shouldStayInArchive ? 'green' : 'yellow'}-700">
                                ${shouldStayInArchive ? 'Картка залишається в архіві' : 'Картка буде переміщена в активні'}
                            </p>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">❌ Помилка симуляції: ${error.message}</p>`;
                console.error('Помилка симуляції:', error);
            }
        });
    </script>
</body>
</html>
